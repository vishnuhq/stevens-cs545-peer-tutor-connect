# Peer-Tutor Connect Backend

Express.js REST API server for the Peer-Tutor Connect platform. Provides authentication, course management, question/response handling, and notification services.

## Table of Contents

1. [Description](#description)
2. [Tech Stack](#tech-stack)
3. [Project Structure](#project-structure)
4. [Database Schema](#database-schema)
5. [API Endpoints](#api-endpoints)
6. [Environment Variables](#environment-variables)
7. [Installation and Setup](#installation-and-setup)
8. [Running Tests](#running-tests)
9. [Troubleshooting](#troubleshooting)

## Description

The backend is a RESTful API built with Express.js that handles all server-side logic for the Peer-Tutor Connect application. It provides secure session-based authentication, comprehensive input validation, and a clean separation between route handlers and data access layers.

Key responsibilities:

- User authentication with Stevens email addresses
- Course and student enrollment management
- Question and response CRUD operations
- Notification system for question responses
- Session management and authorization
- Database operations with MongoDB

## Tech Stack

- **Runtime**: Node.js v24.11.1
- **Framework**: Express.js v5.1.0
- **Database**: MongoDB v7.0.0 (native driver)
- **Authentication**: express-session v1.18.2
- **Password Hashing**: bcrypt v6.0.0 (10 salt rounds)
- **Validation**: express-validator v7.3.0 + custom validation layer
- **Testing**: Jest v30.2.0 with Supertest v7.1.4
- **Security**: helmet v8.1.0, cors v2.8.5
- **Environment**: dotenv v16.6.1

## Project Structure

```
backend/
├── app.js                      # Express application setup and middleware
├── package.json                # Dependencies and npm scripts
├── .env.example                # Environment variable template
├── jest.config.js              # Jest testing configuration
├── middlewares.js              # Custom middleware (auth, logging, errors)
├── validation.js               # Input validation utilities
│
├── database_config/            # MongoDB connection management
│   ├── index.js                # Collection name constants and exports
│   └── mongoConnection.js      # Singleton connection pattern
│
├── data/                       # Data access layer (5 modules)
│   ├── index.js                # Barrel exports for all data functions
│   ├── students.js             # Student CRUD
│   ├── courses.js              # Course CRUD
│   ├── questions.js            # Question CRUD
│   ├── responses.js            # Response CRUD
│   └── notifications.js        # Notification CRUD
│
├── routes/                     # API route handlers (5 modules)
│   ├── index.js                # Route registration
│   ├── auth.js                 # POST /login, /logout; GET /check
│   ├── courses.js              # GET / (student's courses), /:courseId
│   ├── questions.js            # GET /:courseId, /detail/:questionId; POST /; PATCH, DELETE /:questionId
│   ├── responses.js            # GET /:questionId; POST /; PATCH /:responseId, /:responseId/helpful; DELETE /:responseId
│   └── notifications.js        # GET /; PATCH /:notificationId/read, /read-all
│
├── seed/                       # Database seeding scripts
│   ├── index.js                # Main orchestrator (seeds all collections)
│   ├── seedCourses.js          # Seeds 5 Stevens CS/SSW courses
│   ├── seedStudents.js         # Seeds 100 diverse students with hardcoded names
│   ├── seedQuestions.js        # Seeds course-specific questions
│   └── seedResponses.js        # Seeds responses
│
├── tests/                      # Jest test suites (184 tests, all passing)
│   ├── setup.js                # Test environment configuration
│   ├── data/                   # Unit tests for data layer (5 suites)
│   │   ├── students.test.js
│   │   ├── courses.test.js
│   │   ├── questions.test.js
│   │   ├── responses.test.js
│   │   └── notifications.test.js
│   └── routes/                 # Integration tests for routes (5 suites)
│       ├── auth.test.js
│       ├── courses.test.js
│       ├── questions.test.js
│       ├── responses.test.js
│       └── notifications.test.js
│
└── coverage/                   # Jest coverage reports (generated by npm test)
```

## Database Schema

MongoDB database with 5 collections. All collections use MongoDB's default `_id` as ObjectId primary key.

### 1. students Collection

Stores user accounts for Stevens students.

```javascript
{
  _id: ObjectId,                    // Primary key (auto-generated)
  firstName: String,                // Required, 1-50 chars, trimmed
  lastName: String,                 // Required, 1-50 chars, trimmed
  universityEmail: String,          // Required, unique, lowercase, must contain @stevens.edu
  hashedPassword: String,           // Required, bcrypt hash with 10 rounds
  major: String,                    // Required, 1-100 chars (e.g., "Computer Science")
  age: Number,                      // Required, integer 17-25
  enrolledCourses: [ObjectId],      // Array of course IDs (references courses._id)
  createdAt: Date,                  // Timestamp of account creation
  updatedAt: Date                   // Timestamp of last update
}
```

**Indexes:** Unique index on `universityEmail` (lowercase)

### 2. courses Collection

Stores course information.

```javascript
{
  _id: ObjectId,                    // Primary key (auto-generated)
  courseCode: String,               // Required, unique, 1-20 chars (e.g., "CS545")
  courseName: String,               // Required, 1-200 chars (e.g., "Human Computer Interaction")
  section: String,                  // Required, 1-10 chars (e.g., "WS" for web section)
  department: String,               // Required, 1-100 chars (e.g., "Computer Science")
  instructorName: String,           // Required, 1-100 chars (e.g., "Dr. Gregg Vesonder")
  instructorEmail: String,          // Required, valid email
  term: String,                     // Required, 1-50 chars (e.g., "Fall 2025")
  enrolledStudents: [ObjectId],     // Array of student IDs (references students._id)
  createdAt: Date                   // Timestamp of course creation
}
```

**Indexes:** Unique index on `courseCode`

### 3. questions Collection

Stores questions posted by students.

```javascript
{
  _id: ObjectId,                    // Primary key (auto-generated)
  courseId: ObjectId,               // Required, references courses._id
  posterId: ObjectId,               // Required, references students._id
  title: String,                    // Required, 1-200 chars
  content: String,                  // Required, 1-2000 chars
  isAnonymous: Boolean,             // Required, default false
  isResolved: Boolean,              // Required, default false
  createdAt: Date,                  // Timestamp of question creation
  updatedAt: Date                   // Timestamp of last update
}
```

**Indexes:** Index on `courseId` for efficient course-based queries

### 4. responses Collection

Stores responses to questions.

```javascript
{
  _id: ObjectId,                    // Primary key (auto-generated)
  questionId: ObjectId,             // Required, references questions._id
  posterId: ObjectId,               // Required, references students._id (responder)
  content: String,                  // Required, 1-1500 chars
  isAnonymous: Boolean,             // Required, default false
  isHelpful: Boolean,               // Required, default false (marked by question poster)
  createdAt: Date,                  // Timestamp of response creation
  updatedAt: Date                   // Timestamp of last update
}
```

**Indexes:** Index on `questionId` for efficient response retrieval

### 5. notifications Collection

Stores notifications for students.

```javascript
{
  _id: ObjectId,                    // Primary key (auto-generated)
  recipientId: ObjectId,            // Required, references students._id
  questionId: ObjectId,             // Required, references questions._id
  senderId: ObjectId,               // Required, references students._id (who triggered notification)
  type: String,                     // Required, enum: "new_response", "helpful_mark", "question_resolved"
  message: String,                  // Required, notification text
  isRead: Boolean,                  // Required, default false
  createdAt: Date                   // Timestamp of notification creation
}
```

**Indexes:** Index on `recipientId` for efficient user notification queries

## API Endpoints

Base URL: `http://localhost:3000/api`

All endpoints return JSON with consistent format:

```javascript
// Success response
{
  success: true,
  [resource]: { ...data }  // e.g., student, question, courses
}

// Error response
{
  success: false,
  error: "Error message"
}
```

### Authentication Routes (`/api/auth`)

#### POST /api/auth/login

Login with Stevens email and password.

**Request Body:**

```javascript
{
  "universityEmail": "john.smith@stevens.edu",  // Required, must contain @stevens.edu
  "password": "password123"                      // Required
}
```

**Response (200):**

```javascript
{
  "success": true,
  "student": {
    "id": "507f1f77bcf86cd799439011",
    "firstName": "John",
    "lastName": "Smith",
    "email": "john.smith@stevens.edu"
  }
}
```

**Response (401):**

```javascript
{
  "success": false,
  "error": "Invalid email or password"
}
```

**Sets Session Cookie:** httpOnly, sameSite=lax, 48-hour expiry

#### POST /api/auth/logout

Logout and destroy session.

**Authentication:** Required

**Response (200):**

```javascript
{
  "success": true,
  "message": "Logged out successfully"
}
```

#### GET /api/auth/check

Check if user is currently authenticated.

**Response (200) - Authenticated:**

```javascript
{
  "loggedIn": true,
  "student": {
    "id": "507f1f77bcf86cd799439011",
    "firstName": "John",
    "lastName": "Smith",
    "email": "john.smith@stevens.edu"
  }
}
```

**Response (200) - Not Authenticated:**

```javascript
{
  "loggedIn": false
}
```

### Course Routes (`/api/courses`)

#### GET /api/courses

Get all courses the authenticated student is enrolled in.

**Authentication:** Required

**Response (200):**

```javascript
{
  "success": true,
  "courses": [
    {
      "_id": "507f1f77bcf86cd799439012",
      "courseCode": "CS545",
      "courseName": "Human Computer Interaction",
      "section": "WS",
      "department": "Computer Science",
      "instructorName": "Dr. Gregg Vesonder",
      "instructorEmail": "gvesonde@stevens.edu",
      "term": "Fall 2025",
      "enrolledStudents": ["..."],
      "createdAt": "2025-01-13T00:00:00.000Z",
      "newQuestionCount": 3  // Number of questions created in the last 24 hours
    }
  ]
}
```

#### GET /api/courses/:courseId

Get a specific course by ID.

**Authentication:** Required

**Parameters:** `courseId` - MongoDB ObjectId

**Response (200):** Single course object

**Response (404):**

```javascript
{
  "success": false,
  "error": "Course not found"
}
```

### Question Routes (`/api/questions`)

#### GET /api/questions/:courseId

Get all questions for a course with filtering and sorting.

**Authentication:** Required

**Parameters:** `courseId` - MongoDB ObjectId

**Query Parameters:**

- `sort`: Optional, "newest" (default), "oldest", "answered", "unanswered"

**Response (200):**

```javascript
{
  "success": true,
  "questions": [
    {
      "_id": "507f1f77bcf86cd799439015",
      "courseId": "507f1f77bcf86cd799439012",
      "posterId": "507f1f77bcf86cd799439011",
      "title": "Help with Nielsen's Heuristics",
      "content": "I'm confused about...",
      "isAnonymous": false,
      "isResolved": false,
      "createdAt": "2025-01-13T10:30:00.000Z",
      "updatedAt": "2025-01-13T10:30:00.000Z",
      "posterName": "John Smith"
    }
  ]
}
```

#### GET /api/questions/detail/:questionId

Get a single question with full details.

**Authentication:** Required

**Parameters:** `questionId` - MongoDB ObjectId

**Response (200):**

```javascript
{
  "success": true,
  "question": {
    "_id": "507f1f77bcf86cd799439015",
    "courseId": "507f1f77bcf86cd799439012",
    "posterId": "507f1f77bcf86cd799439011",
    "title": "Help with Nielsen's Heuristics",
    "content": "I'm confused about...",
    "isAnonymous": false,
    "isResolved": false,
    "createdAt": "2025-01-13T10:30:00.000Z",
    "updatedAt": "2025-01-13T10:30:00.000Z",
    "posterName": "John Smith"
  }
}
```

#### POST /api/questions

Create a new question.

**Authentication:** Required

**Request Body:**

```javascript
{
  "courseId": "507f1f77bcf86cd799439012",  // Required, ObjectId
  "title": "Question title",                // Required, 1-200 chars
  "content": "Question content",            // Required, 1-2000 chars
  "isAnonymous": false                      // Optional, default false
}
```

**Response (201):**

```javascript
{
  "success": true,
  "question": { ...created question }
}
```

#### PATCH /api/questions/:questionId

Update a question (poster only).

**Authentication:** Required

**Authorization:** Must be the question poster

**Parameters:** `questionId` - MongoDB ObjectId

**Request Body:**

```javascript
{
  "title": "Updated title",        // Optional
  "content": "Updated content",    // Optional
  "isResolved": true               // Optional
}
```

**Response (200):**

```javascript
{
  "success": true,
  "question": { ...updated question }
}
```

#### DELETE /api/questions/:questionId

Delete a question (poster only). **Cascade deletes all associated responses and notifications.**

**Authentication:** Required

**Authorization:** Must be the question poster

**Parameters:** `questionId` - MongoDB ObjectId

**Response (200):**

```javascript
{
  "success": true,
  "message": "Question deleted successfully"
}
```

### Response Routes (`/api/responses`)

#### GET /api/responses/:questionId

Get all responses for a question.

**Authentication:** Required

**Parameters:** `questionId` - MongoDB ObjectId

**Response (200):**

```javascript
{
  "success": true,
  "responses": [
    {
      "_id": "507f1f77bcf86cd799439016",
      "questionId": "507f1f77bcf86cd799439015",
      "posterId": "507f1f77bcf86cd799439014",
      "content": "Here's how...",
      "isAnonymous": false,
      "isHelpful": false,
      "createdAt": "2025-01-13T10:45:00.000Z",
      "updatedAt": "2025-01-13T10:45:00.000Z",
      "posterName": "Jane Doe"
    }
  ]
}
```

#### POST /api/responses

Create a new response to a question.

**Authentication:** Required

**Request Body:**

```javascript
{
  "questionId": "507f1f77bcf86cd799439015",  // Required, ObjectId
  "content": "Here's my answer...",           // Required, 1-1500 chars
  "isAnonymous": false                        // Optional, default false
}
```

**Response (201):**

```javascript
{
  "success": true,
  "response": { ...created response }
}
```

**Side Effect:** Creates notification for question poster

#### PATCH /api/responses/:responseId

Update a response (responder only).

**Authentication:** Required

**Authorization:** Must be the responder

**Parameters:** `responseId` - MongoDB ObjectId

**Request Body:**

```javascript
{
  "content": "Updated content"     // Required, 1-1500 chars
}
```

**Response (200):**

```javascript
{
  "success": true,
  "response": { ...updated response }
}
```

#### PATCH /api/responses/:responseId/helpful

Mark or unmark a response as helpful (question poster only).

**Authentication:** Required

**Authorization:** Must be the question poster

**Parameters:** `responseId` - MongoDB ObjectId

**Request Body:**

```javascript
{
  "isHelpful": true   // Required, boolean (true to mark, false to unmark)
}
```

**Response (200):**

```javascript
{
  "success": true,
  "response": { ...updated response with isHelpful: true }
}
```

#### DELETE /api/responses/:responseId

Delete a response (responder only).

**Authentication:** Required

**Authorization:** Must be the responder

**Parameters:** `responseId` - MongoDB ObjectId

**Response (200):**

```javascript
{
  "success": true,
  "message": "Response deleted successfully"
}
```

### Notification Routes (`/api/notifications`)

#### GET /api/notifications

Get notifications for the authenticated student.

**Authentication:** Required

**Query Parameters:**

- `unreadOnly`: Optional, "true" (default) or "false"

**Response (200):**

```javascript
{
  "success": true,
  "notifications": [
    {
      "_id": "507f1f77bcf86cd799439017",
      "recipientId": "507f1f77bcf86cd799439011",
      "questionId": "507f1f77bcf86cd799439015",
      "senderId": "507f1f77bcf86cd799439014",
      "type": "new_response",
      "message": "Someone replied to your question: Help with Nielsen's Heuristics",
      "isRead": false,
      "createdAt": "2025-01-13T10:45:00.000Z"
    }
  ]
}
```

#### PATCH /api/notifications/:notificationId/read

Mark a specific notification as read.

**Authentication:** Required

**Authorization:** Must be the recipient

**Parameters:** `notificationId` - MongoDB ObjectId

**Response (200):**

```javascript
{
  "success": true,
  "notification": { ...updated notification with isRead: true }
}
```

#### PATCH /api/notifications/read-all

Mark all notifications as read for authenticated student.

**Authentication:** Required

**Response (200):**

```javascript
{
  "success": true,
  "message": "All notifications marked as read",
  "count": 5
}
```

## Environment Variables

Create a `.env` file in the backend directory with these variables:

```bash
# MongoDB Connection
MONGODB_URI=mongodb://localhost:27017
DB_NAME=peer-tutor-connect

# Server Configuration
PORT=3000
NODE_ENV=development

# Session Configuration
SESSION_SECRET=your-super-secret-session-key-change-this-in-production-minimum-32-characters

# CORS Configuration
FRONTEND_URL=http://localhost:5173
```

**Important Notes:**

- `SESSION_SECRET`: Must be a strong, random string (minimum 32 characters) in production
- `FRONTEND_URL`: Must match exactly where your frontend is running (no trailing slash)
- `NODE_ENV`: Set to "production" when deploying to production environment

See `.env.example` for a template.

## Installation and Setup

### 1. Install Dependencies

```bash
cd backend
npm install
```

### 2. Configure Environment

```bash
cp .env.example .env
```

Edit `.env` and update the values as needed (especially `SESSION_SECRET` for production).

### 3. Start MongoDB

Ensure MongoDB is running:

```bash
# macOS (with Homebrew)
brew services start mongodb-community

# Linux
sudo systemctl start mongod

# Windows
net start MongoDB

# Or run manually
mongod --dbpath /path/to/data/directory
```

### 4. Seed Database (Optional but Recommended)

Populate the database with sample data:

```bash
npm run seed
```

This creates:

- 5 Stevens courses (CS545, CS590, CS555, SSW590, CS546)
- 100 diverse student accounts (all with password: `password123`)
- Course-relevant questions
- Helpful responses

**Note:** The seed script will clear existing data before seeding.

### 5. Start Server

**Development mode** (with auto-reload):

```bash
npm run dev
```

**Production mode**:

```bash
npm start
```

Server will start on `http://localhost:3000` (or the PORT specified in `.env`).

### 6. Verify Installation

Test the health check endpoint:

```bash
curl http://localhost:3000/health
```

Expected response:

```javascript
{
  "status": "ok",
  "timestamp": "2025-01-13T12:00:00.000Z"
}
```

## Running Tests

### Run All Tests with Coverage

```bash
npm test
```

This runs all 184 tests serially and generates coverage reports in the `coverage/` directory.

**Expected Output:**

```
Test Suites: 10 passed, 10 total
Tests:       184 passed, 184 total
Time:        ~11s
```

**Coverage Thresholds:**

- Statements: 70%
- Branches: 68%
- Functions: 70%
- Lines: 70%

### Run Tests in Watch Mode

```bash
npm run test:watch
```

Runs tests in watch mode for development. Tests automatically re-run when files change.

### Run Specific Test Suite

```bash
npm test -- tests/data/students.test.js
npm test -- tests/routes/auth.test.js
```

### Test Database

Tests use a separate test database: `peer-tutor-connect-test`

The test database is automatically:

- Created when tests start
- Cleared before each test (beforeEach hooks)
- Cleaned up after all tests (afterAll hooks)

**Important:** Test database is independent from development database.

## Troubleshooting

### MongoDB Connection Issues

**Error: connect ECONNREFUSED 127.0.0.1:27017**

MongoDB is not running. Start it:

```bash
# macOS
brew services start mongodb-community

# Linux
sudo systemctl start mongod

# Check status
mongosh
```

**Error: MongoServerSelectionError**

MongoDB connection string is incorrect. Check:

- `MONGODB_URI` in `.env` is correct
- MongoDB is listening on the correct port
- Firewall isn't blocking port 27017

### Port Already in Use

**Error: listen EADDRINUSE :::3000**

Port 3000 is already in use. Options:

1. Kill the process using port 3000:

```bash
# Find process ID
lsof -i :3000

# Kill process
kill -9 <PID>
```

2. Change port in `.env`:

```bash
PORT=3001
```

### Session/Authentication Issues

**Login succeeds but immediately logs out**

- Check `SESSION_SECRET` is set in `.env`
- Verify `FRONTEND_URL` in `.env` matches frontend exactly (`http://localhost:5173`)
- Clear browser cookies and try again

**CORS errors on API requests**

- Ensure backend `FRONTEND_URL` matches frontend URL exactly
- Check CORS configuration in `app.js`
- Restart backend server after `.env` changes

### Test Failures

**Tests fail randomly or intermittently**

Tests must run serially (not in parallel) due to shared database. Ensure you're using:

```bash
npm test  # Already configured with --runInBand flag
```

**Database state issues in tests**

Clear test database and re-run:

```bash
mongosh
use peer-tutor-connect-test
db.dropDatabase()
exit
npm test
```

### Seed Script Issues

**Seed script fails partway through**

1. Drop database and try again:

```bash
mongosh
use peer-tutor-connect
db.dropDatabase()
exit
npm run seed
```

2. Check MongoDB is running and accessible
3. Verify no existing data conflicts

**Collections are empty after seeding**

- Check console output for errors during seeding
- Verify database name in `.env` matches seed scripts
- Connect to database and verify:

```bash
mongosh
use peer-tutor-connect
show collections
db.students.countDocuments()
db.courses.countDocuments()
```

### Performance Issues

**API responses are slow**

1. Check MongoDB indexes are created (they are created automatically)
2. Monitor MongoDB performance:

```bash
mongosh
use peer-tutor-connect
db.currentOp()
```

**High memory usage**

- Check for memory leaks in long-running processes
- Monitor with: `node --inspect app.js` and Chrome DevTools
- Ensure database connections are properly closed after operations
